# AWS Cloudwatch Logs

## What it is

1. Service that enables collection, storage and analysis of distributed logs in regional centralized location
1. Logs can be collected from EC2 instances, Route 53 and other sources within AWS
1. Logs can be queried using a custom query language
1. Real-time metrics can be created based on analysis of the log streams

## Cloudwatch Agent

[Reference](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Install-CloudWatch-Agent.html)

1.  The Cloudwatch agent can do the following:

    1. Collect logs from EC2 instances
    1. Collect internal system-level metrics from EC2 instances
    1. Retrieve custom metrics from applications or services using StatsD and collectd protocols

1.  Setup of the agent:

    1. Download and install agent on Ubuntu 20 ARM-64

    ```shell
    wget https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/arm64/latest/amazon-cloudwatch-agent.deb
    ```

    Change directory to location of file and

    ```shell
    sudo dpkg -i -E ./amazon-cloudwatch-agent.deb
    ```

    1. Configure the agent

       1. Configuration file is a JSON file that specifies the metrics and logs to be collected, including custom metrics
       1. Can be created using the configuration wizard or by writing from scratch
       1. Agent must be restarted with each change to the configuration file

       ```shell
       sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-config-wizard
       ```

       1. Configuration file is generated by the wizard and stored at /opt/aws/amazon-cloudwatch-agent/bin/

    1. Install collectd if needed

       ```shell
       sudo yum install collectd
       ```

    1. Run the agent

       ```shell
       sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:<configuration-file-path> -s
       ```

       e.g. on Ubuntu

       ```shell
       sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json -s
       ```

    1. Stop the agent

       ```shell
       sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -m ec2 -a stop
       ```

    1. Check that the agent is running

       ```shell
       sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -m ec2 -a status
       ```
