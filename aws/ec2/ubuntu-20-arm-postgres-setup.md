# How to set up a Highly Available Postgres Master-Replica Setup

## Basic Setup for All Machines

1. Update and upgrade packages

   ```shell
   sudo apt-get update -y
   sudo apt-get upgrade -y
   ```

1. Install essential build tools

   ```shell
   sudo apt-get install build-essential -y
   ```

1. Install AWS CLI

   ```shell
   sudo apt -y install awscli
   ```

   1. Most required settings for the CLI will be pulled from the IAM role. To set region:

   ```shell
   aws configure set region ap-south-1
   ```

1. Add some swap

   1. [Reference](https://www.digitalocean.com/community/tutorials/how-to-add-swap-space-on-ubuntu-20-04)

   ```shell
   sudo fallocate -l 1G /swapfile
   ls -lh /swapfile
   sudo chmod 600 /swapfile
   sudo mkswap /swapfile
   sudo swapon /swapfile
   sudo swapon --show
   sudo cp /etc/fstab /etc/fstab.bak
   echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
   sudo sysctl vm.swappiness=10
   ```

1. Install neovim and vimplug and fzf

   ```shell
   sudo snap install nvim --classic
   # sudo apt install -y neovim
   # sudo apt install -y python3-neovim
   # sh -c 'curl -fLo "${XDG_DATA_HOME:-$HOME/.local/share}"/nvim/site/autoload/plug.vim --create-dirs \
   #    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
   curl -fLo /home/ubuntu/.local/share/nvim/site/autoload/plug.vim --create-dirs \
      https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
   sudo chown -R ubuntu:ubuntu /home/ubuntu/.local
   sudo chmod -R 775 /home/ubuntu/.local
   sudo apt-get install -y fzf
   ```

   1. Add preferred configuration

   ```shell
   mkdir /home/ubuntu/.config/nvim/colors -p
   aws s3 cp s3://personal-dev-configs/nvim/init.vim /home/ubuntu/.config/nvim/init.vim
   aws s3 cp s3://personal-dev-configs/nvim/monokai.vim /home/ubuntu/.config/nvim/colors/monokai.vim
   sudo chown -R ubuntu:ubuntu /home/ubuntu/.config
   sudo chmod -R 755 /home/ubuntu/.config
   runuser -l ubuntu -c 'nvim --headless +PlugInstall +qa'
   ```

   1. Edit .bashrc

   ```shell
   echo '' | tee -a /home/ubuntu/.bashrc
   echo '# Replace vim with neovim' | tee -a /home/ubuntu/.bashrc
   echo 'alias vi="nvim"' | tee -a /home/ubuntu/.bashrc
   echo 'alias vim="nvim"' | tee -a /home/ubuntu/.bashrc
   source /home/ubuntu/.bashrc
   ```

1. Setup Cloudwatch Agent to collect logs:

   1. Download and install agent on Ubuntu 20 ARM-64

   ```shell
   wget https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/arm64/latest/amazon-cloudwatch-agent.deb
   ```

   Change directory to location of file and

   ```shell
   sudo dpkg -i -E ./amazon-cloudwatch-agent.deb
   ```

   1. Configure the agent

      1. Configuration file is a JSON file that specifies the metrics and logs to be collected, including custom metrics
      1. Can be created using the configuration wizard or by writing from scratch
      1. Agent must be restarted with each change to the configuration file

      ```shell
      sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-config-wizard
      ```

      1. Configuration file is generated by the wizard and stored at /opt/aws/amazon-cloudwatch-agent/bin/

   1. Install collectd if needed

      ```shell
      sudo yum install collectd
      ```

   1. Run the agent

      ```shell
      sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:<configuration-file-path> -s
      ```

      e.g. on Ubuntu

      ```shell
      sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json -s
      ```

   1. Stop the agent

      ```shell
      sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -m ec2 -a stop
      ```

   1. Check that the agent is running

      ```shell
      sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -m ec2 -a status
      ```

## Postgresql setup

1. Install postgresql

   [Reference for latest version](https://www.postgresql.org/download/linux/ubuntu/)

   ```shell
   # Create the file repository configuration:
   sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
   # Import the repository signing key:
   wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
   # Update the package lists:
   sudo apt-get update
   # Install postgresql-common
   sudo apt-get -y install postgresql-common
   # Edit config of postgresql-common/createcluster.conf to prevent auto-creation of cluster
   # create_main_cluster = false
   # Install the latest version of PostgreSQL.
   # If you want a specific version, use 'postgresql-12' or similar instead of 'postgresql':
   sudo apt-get -y install postgresql
   ```

   1. Key file locations

      1. pg_hba.conf: /etc/postgresql/13/main/pg_hba.conf
      1. postgresql.conf: /etc/postgresql/13/main/postgresql.conf
      1. data_directory: /var/lib/postgresql/13/main/
      1. pid file: /var/run/postgresql/13-main.pid
      1. ident file: /etc/postgresql/13/main/pg_ident.conf

1. Configuration for master and standby

   1. Base setup on both the master and standby

      1. Edit postgresql.conf

         1. Change:
            1. listen_addresses = '\*'
            1. password_encryption = scram-sha-256

      1. Allow remote connections with a password as last line in pg_hba.conf

         ```shell
         host    all             all             all                     scram-sha-256
         ```

   1. Set up WAL archiving on both the master and standby

      1. Edit postgresql.conf
         1. Change:
            1. wal_level = logical
            1. wal_compression = on
            1. archive_mode = on
            1. archive_command
               1. aws s3 cp %p s3://bucket-name/wal-archive-directory/%f

   1. Set up standby to be in recovery mode

      1. Edit postgresql.conf
         1. restore_command
            1. aws s3 cp s3://bucket-name/wal-archive-directory/%f %p
      1. Create standby.signal file in data directory of standby cluster

   1. Prepare databases for streaming replication

      1. Set up auth to allow replication from standby servers

         1. Create a role with replication privileges

         ```shell
         sudo -u postgres createuser --replication -P -e replicator
         ```

         1. Create an entry in pg_hba.conf with the database field set to replication (before the last entry)

         ```shell
         host    replication     all             all                     scram-sha-256
         ```

         1. Ensure max_wal_senders is sufficiently large
         1. Ensure max_replication_slots is sufficiently high

   1. Other
      1. Edit postgresql.conf
         1. Change:
            1. hot_standby = on (on replica)
            1. synchronous_commit = on (or higher, remote_apply to be safest)
            1. synchronous_standby_names = name of replica
      1. Edit pg_hba.conf

1. Configuration for master

   1. Edit postgresql.conf
      1. Change:
         1. listen_addresses = '\*'
         1. synchronous_standby_names = name of replica
   1. Edit pg_hba.conf

1. Configuration for standby

### Streaming Replication

[Ubuntu guide](https://ubuntu.com/server/docs/databases-postgresql)
